unit Unit1;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Error, FireDAC.UI.Intf, FireDAC.Phys.Intf,
  FireDAC.Stan.Def, FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys,
  FireDAC.VCLUI.Wait, FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf,
  FireDAC.DApt, FireDAC.Phys.PGDef, FireDAC.Phys.PG, Data.DB,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client, IniFiles, Unit2,
  Vcl.Imaging.pngimage, Vcl.ExtCtrls, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.VirtualImageList, Vcl.BaseImageCollection,
  Vcl.ImageCollection, connect, ini, uConfigINI;

type
  TForm1 = class(TForm)
    ComboBox1: TComboBox;
    Edit1: TEdit;
    Edit2: TEdit;
    Button1: TButton;
    FDConnection1: TFDConnection;
    FDQuery1: TFDQuery;
    FDPhysPgDriverLink1: TFDPhysPgDriverLink;
    FDQuery2: TFDQuery;
    FDConnection2: TFDConnection;
    Button2: TButton;
    Button3: TButton;
    ImageCollection1: TImageCollection;
    VirtualImageList1: TVirtualImageList;
    ActionList1: TActionList;
    Image1: TImage;
    procedure FormCreate(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
  private
    procedure CargarEmpresas;
    procedure ConectarBase;
  public
    { Public declarations }
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}
procedure TForm1.FormCreate(Sender: TObject);
begin
  try
    ConectarBase;
    CargarEmpresas;
  except
    on E: Exception do
      ShowMessage('Error al conectar con la base de datos: ' + E.Message);
  end;
end;

procedure TForm1.Button2Click(Sender: TObject);
begin
  Application.CreateForm(TForm3, Form3);
  Form3.ShowModal;
  Form3.Free;
  ConectarBase;
end;

procedure TForm1.Button3Click(Sender: TObject);
begin
  Form1.Close;
end;

{===============================================}
{   CONECTAR A LA BASE DE DATOS BASE            }
{===============================================}

procedure TForm1.ConectarBase;
var
  Host, DBName, User, Pass: string;
  Port: Integer;
begin
  // 1️Leer datos del INI
  LeerDatosConexion(Host, DBName, User, Pass, Port);

  // 2️Configurar FDConnection1 usando connect.pas
  if ConfigurarConexion(FDConnection1, Host, DBName, User, Pass, Port) then
    ShowMessage('Conexión correcta con la base de datos: ' + DBName)
end;

{===============================================}
{   CARGAR EMPRESAS EN COMBOBOX                 }
{===============================================}

procedure TForm1.CargarEmpresas;
begin
  ComboBox1.Clear;
  FDQuery1.Close;
  FDQuery1.SQL.Text := 'SELECT empresaname FROM empresa WHERE activa = TRUE ORDER BY orden';
  FDQuery1.Open;

  FDQuery1.First;
  for var i := 0 to FDQuery1.RecordCount - 1 do
  begin
    ComboBox1.Items.Add(FDQuery1.FieldByName('empresaname').AsString);
    FDQuery1.Next;
  end;
end;

{===============================================}
{   LOGIN CLICK                                 }
{===============================================}

procedure TForm1.Button1Click(Sender: TObject);
var
  user, pass: string;
begin
  if ComboBox1.ItemIndex < 0 then
  begin
    ShowMessage('Debe seleccionar una empresa.');
    Exit;
  end;

  FDQuery2.Close;
  FDQuery2.SQL.Text := 'SELECT "host", bdname, userbd, passbd, port FROM empresa WHERE empresaname = :name';
  FDQuery2.ParamByName('name').AsString := ComboBox1.Text;
  FDQuery2.Open;

  if FDQuery2.IsEmpty then
  begin
    ShowMessage('No se encontró la empresa seleccionada.');
    Exit;
  end;

  user := Trim(Edit1.Text);
  pass := Trim(Edit2.Text);

  if (user <> FDQuery2.FieldByName('userbd').AsString) or (pass <> FDQuery2.FieldByName('passbd').AsString) then
  begin
    ShowMessage('Usuario o contraseña incorrectos.');
    Exit;
  end;

  // Configurar conexión a la base de datos de la empresa
  FDConnection2.Connected := False;
  FDConnection2.Params.Clear;
  FDConnection2.DriverName := 'PG';
  FDConnection2.Params.Add('Server=' + FDQuery2.FieldByName('host').AsString);
  FDConnection2.Params.Add('Database=' + FDQuery2.FieldByName('bdname').AsString);
  FDConnection2.Params.Add('User_Name=' + FDQuery2.FieldByName('userbd').AsString);
  FDConnection2.Params.Add('Password=' + FDQuery2.FieldByName('passbd').AsString);
  FDConnection2.Params.Add('Port=' + FDQuery2.FieldByName('port').AsString);

  try
    FDConnection1.Connected := True;
    ShowMessage('Conexión correcta con ' + ComboBox1.Text);

    // Aquí podrías validar usuario/contraseña si existen en la BD de la empresa
    // y luego abrir el formulario principal

    Application.CreateForm(TMainfrm, Mainfrm);
    Mainfrm.Show;
    Self.Hide;

  except
    on E: Exception do
      ShowMessage('Error al conectar con la base de datos de la empresa: ' + E.Message);
  end;
end;
end.
