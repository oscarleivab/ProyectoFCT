unit uLogin;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Error, FireDAC.UI.Intf, FireDAC.Phys.Intf,
  FireDAC.Stan.Def, FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys,
  FireDAC.VCLUI.Wait, FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf,
  FireDAC.DApt, FireDAC.Phys.PGDef, FireDAC.Phys.PG, Data.DB,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client, IniFiles, uMain,
  Vcl.Imaging.pngimage, Vcl.ExtCtrls, System.Actions, Vcl.ActnList,
  System.ImageList, Vcl.ImgList, Vcl.VirtualImageList, Vcl.BaseImageCollection,
  Vcl.ImageCollection, uDBUtils, uIniUtils, uConfig, uNuevaEmpresa;

type
  TfrmLogin = class(TForm)
    ComboBox1: TComboBox;
    Edit1: TEdit;
    Edit2: TEdit;
    Button1: TButton;
    FDConnection1: TFDConnection;
    FDQuery1: TFDQuery;
    FDPhysPgDriverLink1: TFDPhysPgDriverLink;
    FDQuery2: TFDQuery;
    FDConnection2: TFDConnection;
    Button2: TButton;
    Button3: TButton;
    ImageCollection1: TImageCollection;
    VirtualImageList1: TVirtualImageList;
    ActionList1: TActionList;
    Image1: TImage;
    procedure FormCreate(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
  private
    procedure CargarEmpresas;
    procedure ConectarBase;
  public
    LoginExitoso: Boolean;
  end;

var
  frmLogin: TfrmLogin;

implementation

{$R *.dfm}
procedure TfrmLogin.FormCreate(Sender: TObject);
begin
  try
    ConectarBase;
    FDQuery1.SQL.Text := 'SELECT COUNT(*) AS total FROM empresa';
    FDQuery1.Open;
    if FDQuery1.FieldByName('total').AsInteger = 0 then
    begin
      ShowMessage('Primera ejecución: debe crear una empresa.');
      Application.CreateForm(TfrmNuevaEmpresa, frmNuevaEmpresa);
      frmNuevaEmpresa.ShowModal;
      frmNuevaEmpresa.Free;
      CargarEmpresas;
    end
    else
      CargarEmpresas;
  except
    on E: Exception do
      ShowMessage('Error al conectar con la base de datos: ' + E.Message);
  end;
end;

procedure TfrmLogin.Button2Click(Sender: TObject);
begin
  Application.CreateForm(TfrmConfig, frmConfig);
  frmConfig.ShowModal;
  frmConfig.Free;
  ConectarBase;
end;

procedure TfrmLogin.Button3Click(Sender: TObject);
begin
  frmLogin.Close;
end;

{===============================================}
{   CONECTAR A LA BASE DE DATOS BASE            }
{===============================================}

procedure TfrmLogin.ConectarBase;
var
  Host, DBName, User, Pass: string;
  Port: Integer;
begin
  // 1️Leer datos del INI
  LeerDatosConexion(Host, DBName, User, Pass, Port);

  // 2️Configurar FDConnection1 usando connect.pas
  if ConfigurarConexion(FDConnection1, Host, DBName, User, Pass, Port) then
    ShowMessage('Conexión correcta con la base de datos: ' + DBName)
end;

{===============================================}
{   CARGAR EMPRESAS EN COMBOBOX                 }
{===============================================}

procedure TfrmLogin.CargarEmpresas;
begin
  ComboBox1.Clear;
  FDQuery1.Close;
  FDQuery1.SQL.Text := 'SELECT empresaname FROM empresa WHERE activa = TRUE ORDER BY orden';
  FDQuery1.Open;

  FDQuery1.First;
  for var i := 0 to FDQuery1.RecordCount - 1 do
  begin
    ComboBox1.Items.Add(FDQuery1.FieldByName('empresaname').AsString);
    FDQuery1.Next;
  end;
end;

{===============================================}
{   LOGIN CLICK                                 }
{===============================================}

procedure TfrmLogin.Button1Click(Sender: TObject);
var
  user, pass: string;
  BDName, Host: string;
begin
  if ComboBox1.ItemIndex < 0 then
  begin
    ShowMessage('Debe seleccionar una empresa.');
    Exit;
  end;

  FDQuery2.Close;
  FDQuery2.SQL.Text := 'SELECT "host", bdname, userbd, passbd, port FROM empresa WHERE empresaname = :name';
  FDQuery2.ParamByName('name').AsString := ComboBox1.Text;
  FDQuery2.Open;

  if FDQuery2.IsEmpty then
  begin
    ShowMessage('No se encontró la empresa seleccionada.');
    Exit;
  end;

  user := Trim(Edit1.Text);
  pass := Trim(Edit2.Text);

  if (user <> FDQuery2.FieldByName('userbd').AsString) or
     (pass <> FDQuery2.FieldByName('passbd').AsString) then
  begin
    ShowMessage('Usuario o contraseña incorrectos.');
    Exit;
  end;

  Host := FDQuery2.FieldByName('host').AsString;
  BDName := FDQuery2.FieldByName('bdname').AsString;

  if not ConfigurarConexion(FDConnection2, Host, BDName, 'postgres', '2003',
         FDQuery2.FieldByName('port').AsInteger) then
  begin
    ShowMessage('No se pudo conectar con la base de datos ' + ComboBox1.Text);
    Exit;
  end;

  // Configurar conexión a la base de datos de la empresa
//  FDConnection2.Connected := False;
//  FDConnection2.Params.Clear;
//  FDConnection2.DriverName := 'PG';
//  FDConnection2.Params.Values['Server'] := Host;
//  FDConnection2.Params.Values['Database'] := BDName;
//  FDConnection2.Params.Values['User_Name'] := 'postgres';
//  FDConnection2.Params.Values['Password'] := '2003';
//  FDConnection2.Params.Values['Port'] := FDQuery2.FieldByName('port').AsString;

//  try
//    FDConnection2.Connected := True;
//    ShowMessage('Conexión correcta con ' + ComboBox1.Text);
//
//    //frmMain.Enabled := True;
//    //frmMain.Show;
//    //Self.Close;
//    LoginExitoso := True;
//    Close;
//  except
//    on E: Exception do
//      ShowMessage('Error al conectar con la base de datos de la empresa: ' + E.Message);
//  end;
  ShowMessage('Conexión realizada con ' + ComboBox1.Text);
  LoginExitoso := True;
  Close;
end;
end.
