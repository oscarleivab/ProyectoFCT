unit Unit4;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  FireDAC.UI.Intf, FireDAC.Stan.Def, FireDAC.Stan.Pool, FireDAC.Phys,
  FireDAC.VCLUI.Wait, Data.DB, FireDAC.Comp.Client, FireDAC.Comp.DataSet, connect, ini;

type
  TForm4 = class(TForm)
    Edit1: TEdit;
    Edit2: TEdit;
    Edit3: TEdit;
    Edit4: TEdit;
    Edit5: TEdit;
    Button1: TButton;
    Button2: TButton;
    FDQuery1: TFDQuery;
    FDConnection1: TFDConnection;
    procedure Button2Click(Sender: TObject);
    procedure Button1Click(Sender: TObject);
  private
    procedure CrearNuevaBaseDatos;
  public
    { Public declarations }
  end;

var
  Form4: TForm4;

implementation

{$R *.dfm}

procedure TForm4.Button1Click(Sender: TObject);
begin
  try
    CrearNuevaBaseDatos;
    ShowMessage('Empresa creada correctamente.');
    Close;
  except
    on E: Exception do
      ShowMessage('Error al crear la empresa: ' + E.Message);
  end;
end;

{=========================================}
{   BOTÓN CONTINUAR SIN AÑADIR            }
{=========================================}
procedure TForm4.Button2Click(Sender: TObject);
begin
  if MessageDlg('¿Seguro que desea continuar sin crear una empresa?',
    mtConfirmation, [mbYes, mbNo], 0) = mrYes then
  begin
    Close; // simplemente cierra el formulario
  end;
end;

{=========================================}
{   CREAR NUEVA BASE DE DATOS             }
{=========================================}
procedure TForm4.CrearNuevaBaseDatos;
var
  ConnGeneral, ConnNueva: TFDConnection;
  Q: TFDQuery;
begin
  if (Trim(Edit1.Text) = '') or (Trim(Edit2.Text) = '') or (Trim(Edit3.Text) = '') then
    raise Exception.Create('Debe completar todos los campos.');

  // Crear conexión a la base general
  ConnGeneral := TFDConnection.Create(nil);
  try
    if not ConfigurarConexion(ConnGeneral, 'localhost', 'bdgevensoftbase', 'postgres', '2003', 5432) then
      raise Exception.Create('No se pudo conectar a la base general.');

    Q := CrearQuery(ConnGeneral);
    try
      // Crear nueva base de datos
      Q.SQL.Text := 'CREATE DATABASE ' + Edit2.Text;
      Q.ExecSQL;
    finally
      Q.Free;
    end;

    // Crear conexión a la nueva base
    ConnNueva := TFDConnection.Create(nil);
    try
      if not ConfigurarConexion(ConnNueva, 'localhost', Edit2.Text, 'postgres', '2003', 5432) then
        raise Exception.Create('No se pudo conectar a la nueva base.');

      Q := CrearQuery(ConnNueva);
      try
        // Crear tabla empleado
        Q.SQL.Text :=
          'CREATE TABLE empleado (' +
          'id SERIAL PRIMARY KEY, ' +
          'usuario VARCHAR(50), ' +
          'password VARCHAR(50), ' +
          'nombre VARCHAR(100)' +
          ');';
        Q.ExecSQL;

        // Insertar empleado inicial
        Q.SQL.Text := 'INSERT INTO empleado (usuario, password, nombre) VALUES (:u, :p, :n)';
        Q.ParamByName('u').AsString := Edit3.Text;
        Q.ParamByName('p').AsString := Edit4.Text;
        Q.ParamByName('n').AsString := Edit1.Text + ' Admin';
        Q.ExecSQL;
      finally
        Q.Free;
      end;

      // Registrar la empresa en la base general
      Q := CrearQuery(ConnGeneral);
      try
        Q.SQL.Text :=
          'INSERT INTO empresa (empresaname, host, bdname, userbd, passbd, port, activa, orden) ' +
          'VALUES (:n, :h, :b, :u, :p, :pt, TRUE, 1)';
        Q.ParamByName('n').AsString := Edit1.Text;
        Q.ParamByName('h').AsString := 'localhost';
        Q.ParamByName('b').AsString := Edit2.Text;
        Q.ParamByName('u').AsString := Edit3.Text;
        Q.ParamByName('p').AsString := Edit4.Text;
        Q.ParamByName('pt').AsInteger := 5432;
        Q.ExecSQL;
      finally
        Q.Free;
      end;

    finally
      ConnNueva.Free;
    end;

  finally
    ConnGeneral.Free;
  end;
end;

end.
