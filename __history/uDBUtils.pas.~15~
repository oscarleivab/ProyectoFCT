unit uDBUtils;

interface

uses
  System.SysUtils, FireDAC.Comp.Client, Vcl.Dialogs, System.Variants;

{------------------------------------------------------------
  MÓDULO: uDBUtils
  ------------------------------------------------------------
  Este módulo centraliza toda la lógica relacionada con:

    ✅ Conexiones con FireDAC
    ✅ Creación de consultas (TFDQuery)
    ✅ Ejecución de consultas SQL genéricas
    ✅ Verificación de registros
    ✅ Obtención de valores de una tabla

  El objetivo es NO repetir código SQL en los formularios.
-------------------------------------------------------------}

function ConfigurarConexion(FDConn: TFDConnection; Servidor, BaseDatos, Usuario, Clave: string;
                            Puerto: Integer = 5432): Boolean;

function CrearQuery(Conexion: TFDConnection): TFDQuery;

{ Funciones genéricas SQL }
function EjecutarSQL(Conexion: TFDConnection; const SQL: string): Boolean;
function EjecutarSQLConParametros(Conexion: TFDConnection; const SQL: string; const Params: array of Variant): Boolean;
function ExisteRegistro(Conexion: TFDConnection; const SQL: string): Boolean;
function ContarRegistros(Conexion: TFDConnection; const SQL: string): Integer;
function ObtenerValor(Conexion: TFDConnection; const SQL: string): Variant;

implementation

{------------------------------------------------------------
  FUNCIÓN: ConfigurarConexion
  ------------------------------------------------------------
  Configura un TFDConnection con los parámetros recibidos.

  ✅ Asigna host, usuario, contraseña, puerto, etc.
  ✅ Intenta conectarse automáticamente.
  ✅ Si falla muestra un error claro.
-------------------------------------------------------------}
function ConfigurarConexion(FDConn: TFDConnection; Servidor, BaseDatos, Usuario, Clave: string;
                            Puerto: Integer): Boolean;
begin
  Result := False;

  FDConn.Connected := False;
  FDConn.Params.Clear;

  FDConn.DriverName := 'PG';
  FDConn.Params.Values['Server']   := Servidor;
  FDConn.Params.Values['Database'] := BaseDatos;
  FDConn.Params.Values['User_Name']:= Usuario;
  FDConn.Params.Values['Password'] := Clave;
  FDConn.Params.Values['Port']     := IntToStr(Puerto);

  try
    FDConn.Connected := True;
    Result := True;

  except
    on E: Exception do
      ShowMessage('❌ No se pudo conectar: ' + E.Message);
  end;
end;

{------------------------------------------------------------
  FUNCIÓN: CrearQuery
  ------------------------------------------------------------
  Crea y devuelve un TFDQuery asociado a una conexión.

  ✅ Se usa para no depender de FDQuery colocadas en formularios.
-------------------------------------------------------------}
function CrearQuery(Conexion: TFDConnection): TFDQuery;
begin
  Result := TFDQuery.Create(nil);
  Result.Connection := Conexion;
end;

{------------------------------------------------------------
  FUNCIÓN: EjecutarSQL
  ------------------------------------------------------------
  Ejecuta un SQL sin parámetros (INSERT, UPDATE, DELETE).
-------------------------------------------------------------}
function EjecutarSQL(Conexion: TFDConnection; const SQL: string): Boolean;
var
  Q: TFDQuery;
begin
  Result := False;
  Q := CrearQuery(Conexion);
  try
    Q.SQL.Text := SQL;
    Q.ExecSQL;
    Result := True;

  except
    on E: Exception do
      ShowMessage('Error al ejecutar SQL: ' + E.Message);
  end;

  Q.Free;
end;

{------------------------------------------------------------
  FUNCIÓN: EjecutarSQLConParametros
  ------------------------------------------------------------
  Igual que EjecutarSQL pero permite pasar parámetros al query.
-------------------------------------------------------------}
function EjecutarSQLConParametros(Conexion: TFDConnection; const SQL: string;
                                  const Params: array of Variant): Boolean;
var
  Q: TFDQuery;
  I: Integer;
begin
  Result := False;
  Q := CrearQuery(Conexion);
  try
    Q.SQL.Text := SQL;

    // Cargar parámetros dinámicamente
    for I := 0 to High(Params) do
      Q.Params[I].Value := Params[I];

    Q.ExecSQL;
    Result := True;

  except
    on E: Exception do
      ShowMessage('Error al ejecutar SQL parametrizado: ' + E.Message);
  end;

  Q.Free;
end;

{------------------------------------------------------------
  FUNCIÓN: ExisteRegistro
  ------------------------------------------------------------
  Devuelve TRUE si una consulta devuelve al menos 1 registro.
-------------------------------------------------------------}
function ExisteRegistro(Conexion: TFDConnection; const SQL: string): Boolean;
var
  Q: TFDQuery;
begin
  Q := CrearQuery(Conexion);
  try
    Q.SQL.Text := SQL;
    Q.Open;

    Result := not Q.IsEmpty;

  finally
    Q.Free;
  end;
end;

{------------------------------------------------------------
  FUNCIÓN: ContarRegistros
  ------------------------------------------------------------
  Devuelve el valor del primer campo de la consulta.
  Suele usarse para SELECT COUNT(*)
-------------------------------------------------------------}
function ContarRegistros(Conexion: TFDConnection; const SQL: string): Integer;
var
  Q: TFDQuery;
begin
  Result := 0;

  Q := CrearQuery(Conexion);
  try
    Q.SQL.Text := SQL;
    Q.Open;

    if not Q.Fields[0].IsNull then
      Result := Q.Fields[0].AsInteger;

  finally
    Q.Free;
  end;
end;

{------------------------------------------------------------
  FUNCIÓN: ObtenerValor
  ------------------------------------------------------------
  Devuelve un valor único de la consulta.
  Ejemplo: SELECT nombre FROM tabla LIMIT 1
-------------------------------------------------------------}
function ObtenerValor(Conexion: TFDConnection; const SQL: string): Variant;
var
  Q: TFDQuery;
begin
  Q := CrearQuery(Conexion);
  try
    Q.SQL.Text := SQL;
    Q.Open;

    if not Q.IsEmpty then
      Result := Q.Fields[0].Value
    else
      Result := Null;

  finally
    Q.Free;
  end;
end;

end.

